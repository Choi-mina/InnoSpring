<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
  <link href="https://fonts.googleapis.com/css?family=Cairo&display=swap" rel="stylesheet" />
  <link href="../css/home.css" rel="stylesheet" type="text/css"/>
  <title>Login</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-size: 14px;
      overflow: scroll;
    }
    .frame-container {
      top: 100px;
      left: 0px;
      width: 100%;
      height: 87%;
      position: absolute;
      align-items: center;
    }
    .sign-up-div {
      top: 20%;
      left: 40%;
      width: 20%;
      height: 70%;
      position: relative;
    }
    .sign-up-text {
      color: rgba(0,0,0,1);
      position: absolute;
      width: 100%;
      top: 5%;
      font-weight: Bold;
      font-size: x-large;
      text-align: center;
    }
    /* login-form의 스타일 설정 */
    .sign-up-form {
      margin-top: 10px;
      position: absolute;
      top: 15%;
      width: 100%;
    }

    .sign-up-form form {
      display: flex;
      flex-direction: column;
    }

    .sign-up-form input[type="text"],
    .sign-up-form input[type="password"] {
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }

    .sign-up-form input[type="submit"] {
      padding: 10px;
      background-color: #4CAF50;
      border: none;
      border-radius: 3px;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    .sign-up-form input[type="submit"]:hover {
      background-color: #45a049;
    }

    .email-container {
      display: flex;
      align-items: center;
    }

    .email-container input[name="email"] {
      width: auto; /* Adjust width as necessary */
      flex: 1;
    }

    .email-container button {
      height: 30px;
      margin-left: 10px;
      margin-bottom: 10px;
      padding: 10px;
      background-color: #4CAF50;
      border: none;
      border-radius: 3px;
      color: white;
      font-size: 10px;
      cursor: pointer;
    }

    .email-container button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
<th:block layout:fragment="header" th:include="@{fragments/header}"></th:block>
<div class="frame-container">
  <div class="sign-up-div" id="sign-up-div">
    <span class="sign-up-text">Sign Up</span>
    <div class="sign-up-form">
      <form method="post" id="sign-up-form" action="/sign-up-result" th:object="${memberDto}">
        <input type="text" name="userName" th:field="*{userName}" placeholder="UserName">
        <input type="text" name="phoneNum" class="form-control" oninput="oninputPhone(this)" maxlength="13" th:field="*{phoneNum}" placeholder="PhoneNum">
        <div class="email-container">
          <input type="text" name="email" th:field="*{email}" placeholder="Email">
          <button id="emailCheck" type="button">중복확인</button>
        </div>
        <input type="password" name="password" th:field="*{password}" placeholder="Password">
        <input type="submit" value="SignUp">
      </form>
    </div>
  </div>
</div>
<th:block layout:fragment="footer" th:include="@{fragments/footer}"></th:block>
<script>

  // 0: 버튼을 클릭하지 않음, 1: 이미 존재하는 이메일, 2: 중복확인 완료
  var emailCheckFlag = 0;

  function oninputPhone(target) {
    target.value = target.value
            .replace(/[^0-9]/g, '')
            .replace(/(^02.{0}|^01.{1}|[0-9]{3,4})([0-9]{3,4})([0-9]{4})/g, "$1-$2-$3");
  }

  // 회원가입 전 유효성 검증
  function validateForm(event) {
    event.preventDefault();

    var form = document.getElementById("sign-up-form");
    var userName = form.querySelector('[name="userName"]');
    var phoneNum = form.querySelector('[name="phoneNum"]');
    var email = form.querySelector('[name="email"]');
    var password = form.querySelector('[name="password"]');

    if (!userName || userName.value === "") {
      alert("이름을 입력해주세요.");
      return false;
    }

    if (!phoneNum || phoneNum.value === "" || phoneNum.value.length !== 13) {
      alert("올바른 휴대폰 번호를 입력해주세요.");
      return false;
    }

    var emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
    if (!email || email.value === "" || !emailPattern.test(email.value)) {
      alert("올바른 주소를 입력해주세요.");
      return false;
    }

    if (!password || password.value === "" || password.value.length < 7) {
      alert("7글자 이상의 비밀번호를 입력해주세요.");
      return false;
    }

    if (emailCheckFlag == 0) {
      alert("이메일 중복확인을 해주세요.");
      return false;
    } else if (emailCheckFlag == 1) {
      alert("이미 존재하는 회원입니다. 다른 이메일을 입력 후 중복확인을 해주세요.");
      return false;
    }

    var memberDto = {
      userName: userName.value,
      phoneNum: phoneNum.value,
      email: email.value,
      password: password.value
    };

    ajaxPostJsonCall('/sign-up-result', JSON.stringify(memberDto), function(data) {
      if (data.code === "0000") {
        alert("회원가입 성공");
        window.location.href = "/login";
      } else {
        console.log("이미 존재하는 회원");
        alert("회원가입에 실패했습니다. 잠시후에 이용해주세요.");
      }
    }, function(error) {
      alert("An error occurred: " + error.message);
    });
  }

  window.onload = function() {
    document.getElementById("sign-up-form").addEventListener("submit", validateForm);

    document.getElementById("emailCheck").addEventListener("click", function(event) {
      event.preventDefault();
      var form = document.getElementById("sign-up-form");
      var email = form.querySelector('[name="email"]');
      var emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
      if (!email || email.value === "" || !emailPattern.test(email.value)) {
        alert("Invalid email address");
      } else {
        ajaxJsonCall('/find-email?email=' + encodeURIComponent(email.value), null, function(data) {
          if (data.code === "0000") {
            emailCheckFlag = 1;
            alert("이미 존재하는 회원입니다. 다른 이메일을 입력해주세요.");
          } else {
            emailCheckFlag = 2;
            alert("사용 가능한 이메일입니다.");

          }
        }, function(error) {
          alert("An error occurred: " + error.message);
        });
      }
    });
  }
</script>
</body>
</html>
